<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>public.js - Docdash</title>
    
    <meta name="description" content="A clean, responsive documentation template theme for JSDoc 3." />
    
        <meta name="keywords" content="jsdoc, docdash" />
        <meta name="keyword" content="jsdoc, docdash" />
    
    
    
    <meta property="og:title" content="Docdash"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://cloud.githubusercontent.com/assets/447956/13398144/4dde7f36-defd-11e5-8909-1a9013302cb9.png"/>
    <meta property="og:site_name" content="Docdash"/>
    <meta property="og:url" content="http://clenemt.github.io/docdash/"/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Check.html">Check</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Check.html#then">then</a></li></ul></li><li><a href="Clock.html">Clock</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Clock.html#close">close</a></li><li data-type='method' style='display: none;'><a href="Clock.html#onStatusChange">onStatusChange</a></li><li data-type='method' style='display: none;'><a href="Clock.html#pause">pause</a></li><li data-type='method' style='display: none;'><a href="Clock.html#reInit">reInit</a></li><li data-type='method' style='display: none;'><a href="Clock.html#restart">restart</a></li><li data-type='method' style='display: none;'><a href="Clock.html#start">start</a></li></ul></li><li><a href="InnerAudio.html">InnerAudio</a><ul class='methods'><li data-type='method' style='display: none;'><a href="InnerAudio.html#onStatusChange">onStatusChange</a></li><li data-type='method' style='display: none;'><a href="InnerAudio.html#play">play</a></li><li data-type='method' style='display: none;'><a href="InnerAudio.html#setSrc">setSrc</a></li><li data-type='method' style='display: none;'><a href="InnerAudio.html#stop">stop</a></li></ul></li><li><a href="RecorderManager.html">RecorderManager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="RecorderManager.html#onStatusChange">onStatusChange</a></li><li data-type='method' style='display: none;'><a href="RecorderManager.html#start">start</a></li><li data-type='method' style='display: none;'><a href="RecorderManager.html#stop">stop</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-AxiosPlugin.html">AxiosPlugin</a></li><li><a href="module-canvas.html">canvas</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-canvas.html#~drawRoundRectPath">drawRoundRectPath</a></li><li data-type='method' style='display: none;'><a href="module-canvas.html#~fillRoundRect">fillRoundRect</a></li></ul></li><li><a href="module-filter.html">filter</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-filter.html#~fmoney%25E8%25B4%25A7%25E5%25B8%2581%25E6%25A0%25BC%25E5%25BC%258F%25E5%258C%2596">fmoney 货币格式化</a></li><li data-type='method' style='display: none;'><a href="module-filter.html#~signature%25E6%25AD%25A3%25E8%25B4%259F%25E7%25AC%25A6%25E5%258F%25B7">signature 正负符号</a></li><li data-type='method' style='display: none;'><a href="module-filter.html#~suffix%25E5%2589%258D%25E5%2590%258E%25E7%25BC%2580">suffix 前后缀</a></li></ul></li><li><a href="module-libs.html">libs</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-libs.html#~calcAge%25E8%25AE%25A1%25E7%25AE%2597%25E5%25B9%25B4%25E9%25BE%2584">calcAge 计算年龄</a></li><li data-type='method' style='display: none;'><a href="module-libs.html#~fmoney%25E9%2587%2591%25E9%25A2%259D%25E6%25A0%25BC%25E5%25BC%258F%25E5%258C%2596">fmoney 金额格式化</a></li><li data-type='method' style='display: none;'><a href="module-libs.html#~formatDate%25E6%25A0%25BC%25E5%25BC%258F%25E5%258C%2596%25E6%2597%25B6%25E9%2597%25B4">formatDate 格式化时间</a></li><li data-type='method' style='display: none;'><a href="module-libs.html#~sleep%25E7%25AD%2589%25E5%25BE%2585">sleep 等待</a></li></ul></li><li><a href="module-public.html">public</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-public.html#~Connect%25E8%25BF%259E%25E6%258E%25A5%25E8%25BF%259C%25E7%25A8%258B%25E7%2594%25B5%25E8%2584%2591">Connect 连接远程电脑</a></li><li data-type='method' style='display: none;'><a href="module-public.html#~Shell%25E8%25BF%2590%25E8%25A1%258Cshell%25E5%2591%25BD%25E4%25BB%25A4">Shell 运行shell命令</a></li><li data-type='method' style='display: none;'><a href="module-public.html#~UploadFile%25E4%25B8%258A%25E4%25BC%25A0%25E6%2596%2587%25E4%25BB%25B6">UploadFile 上传文件</a></li></ul></li><li><a href="module-wepp.html">wepp</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-wepp.html#~bs64Tofilebase64%25E8%25BD%25AC%25E6%2596%2587%25E4%25BB%25B6">bs64Tofile base64转文件</a></li><li data-type='method' style='display: none;'><a href="module-wepp.html#~chooseImageByCapture">chooseImageByCapture</a></li><li data-type='method' style='display: none;'><a href="module-wepp.html#~chooseImageFromAlbum">chooseImageFromAlbum</a></li><li data-type='method' style='display: none;'><a href="module-wepp.html#~fileTobs64%25E6%2596%2587%25E4%25BB%25B6%25E8%25BD%25ACbase64">fileTobs64 文件转base64</a></li><li data-type='method' style='display: none;'><a href="module-wepp.html#~saveFile%25E4%25BF%259D%25E5%25AD%2598%25E4%25B8%25B4%25E6%2597%25B6%25E6%2596%2587%25E4%25BB%25B6">saveFile 保存临时文件</a></li><li data-type='method' style='display: none;'><a href="module-wepp.html#~saveImageToPhotosAlbum%25E4%25BF%259D%25E5%25AD%2598%25E5%2588%25B0%25E7%259B%25B8%25E5%2586%258C">saveImageToPhotosAlbum 保存到相册</a></li></ul></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-webpack.prod.conf.html">webpack 生产配置</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">public.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module public
 * @desc nodejs 前端自动部署
 * @author xiedrsz
 * @since 2018.09.04
 * @example
 * // 用法：
 * // [1] 将该文件放置与 build 文件夹中
 * // [2] 配置 package.json
 * "scripts": {
 *    "public": "npm run build &amp;&amp; node build/public.js"
 *  }
 */

// .public.js
// module.exports = {
//   "host": "10.6.99.105",
//   "port": "22",
//   "username": "root",
//   "password": "qOoxhNzjxG@20171222",
//   "ROOT": "/software/workspace/jiulong-web/apache-tomcat-8.5.27/webapps/ROOT/"
// }

"use strict"
var ssh2 = require("ssh2");
var Client = ssh2.Client;
var config = require('../.public.js')
var ROOT = config.ROOT

/**
 * @function Connect 连接远程电脑
 * @desc 连接远程电脑
 * @param {object} server - 远程电脑凭证
 * @param {function(client)} then - 回调函数
 */
function Connect (server, then) {
	var conn = new Client();
	conn.on("ready", function () {
    console.log('Client :: ready');
		then(conn);
	}).on('error', function (err) {
		//console.log("connect error!");
	}).on('end', function () {
		//console.log("connect end!");
	}).on('close', function (had_error) {
		//console.log("connect close");
	}).connect(server);
}

/**
 * @function Shell 运行shell命令
 * @desc 运行shell命令
 * @param {object} server - 远程电脑凭证
 * @param {string} cmd - 执行的命令
 * @param {function} then - 回调函数
 */
function Shell(server, cmd, then){
	Connect(server, function (conn) {
		conn.shell(function (err, stream) {
      if (err) throw err;
      stream
        .on('close', function() {
          console.log('Stream :: close');
          then()
          conn.end();
        })
        .on('data', function (data) {
          console.log('STDOUT: ' + data);
        })
        .stderr.on('data', function(data) {
          console.log('STDERR: ' + data);
        });
      stream.end(cmd);
		});
	});	
}

/**
 * @function UploadFile 上传文件
 * @desc 上传文件
 * @param {object} server - 远程电脑凭证
 * @param {string} localPath - 本地路径
 * @param {string} remotePath - 远程路径
 * @param {function(err, result)} then - 回调函数
 */
function UploadFile(server, localPath, remotePath , then){
	Connect(server, function(conn){
		conn.sftp(function(err, sftp){
			if(err){
				then(err);
			}else{
				sftp.fastPut(localPath, remotePath, function(err, result){
					conn.end();
					then(err, result);
				});
			}
		});
	});
}

// console.log('本地发布已关闭，请前往 Jenkins 发布')

/**
* 描述：发布
* [1] 上传文件 [2] 跳转到静态文件根目录 [3] 删除static文件夹 [4] 解压 [5] 删除dist.zip [6] 登出
* 回调：then(err, result)
*/
UploadFile(config, './dist/dist.zip', ROOT + 'dist.zip', function (err, res) {
  if (err) 
    console.log(err);
  console.log('Upload Finish!!')
  var sh = 'cd ' + ROOT + ' &amp;&amp; rm -rf static/ &amp;&amp; unzip -o dist.zip &amp;&amp; rm -f dist.zip &amp;&amp; logout\n'
  Shell(config, sh, function (err, res) {
    console.log('Public success!!')
  })
})
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
